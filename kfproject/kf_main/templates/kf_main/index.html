{% load static %}

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Index</title>
    <link rel="icon" href="data:;base64,=" />
    <link rel="stylesheet" type="text/css" href="{% static 'kf_main/style.css' %}" />
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  </head>
  <body>
    <button class="deck_category" id="top100" type="submit">Top 100</button>

    <div id="center_form">
      <div id="search_bar_div">
        <input
          id="deck_search"
          type="text"
          name="search_string"
          placeholder="Enter a deck name"
        />
        <button class="deck_category" id="deck_search_btn" type="submit">⌕</button>
      </div>

      {% if message %}
      <div id="message">{{ message }}</div>
      {% else %}
      <div id="message"></div>
      {% endif %}
    </div>

    <div class="deck_wrapper"></div>
    <div class="pagination"></div>

    <script>
      let deck_wrapper = document.querySelector(".deck_wrapper");
      let deck_category = document.querySelectorAll(".deck_category");
      let form_position = document.querySelector("#center_form");
      let message = document.querySelector("#message");
      let page = 1;

      deck_category.forEach(function(category) {
        category.addEventListener("click", function() {
          form_position.style.height = "20%";
          message.innerText = "Loading..."; //needs to be fixed for double click
          if (category.innerText == "Top 100") {
            top100();
          } else if (category.innerText == "⌕") {
            search(page);
          }
        });
      });

      function top100() {
        deck_wrapper.style.opacity = "0";
        axios.get("{% url 'kf_main:get_top100' %}").then(function(response) {
          let top100 = response.data;
          console.log(response.data);
          create_decks(top100, message);
        });
      }

      function search(pg) {
        let search = document.querySelector("#deck_search").value;
        deck_wrapper.style.opacity = "0";
        axios
          .post(
            "{% url 'kf_main:search' %}",
            {
              search: search,
              page: pg
            },
            {
              headers: {
                "X-CSRFToken": "{{ csrf_token }}"
              }
            }
          )
          .then(function(response) {
            clear_decks();
            let results = response.data;
            window.scrollTo({ top: 0, behavior: 'smooth' });
            create_decks(results["deck_dict2"], message);
            paginate(results["page_range"]);
          });
      }

      function paginate(page_range) {
        let pagination = document.querySelector(".pagination");

        for (let i = 0; i < page_range.length; i++) {
          let page_link = document.createElement("div");
          page_link.className = "page";
          if (page_range[i] == page) {
            page_link.id = "active";
          }
          page_link.onclick = function() {
            deck_wrapper.style.opacity = "0";
            while (pagination.firstChild) {
              pagination.firstChild.remove();
            }
            page = this.innerText;
            search(page_range[i]);
          };
          page_link.innerText = page_range[i];
          pagination.appendChild(page_link);
        }
      }

      function clear_decks() {
        while (deck_wrapper.firstChild) {
          deck_wrapper.firstChild.remove();
        }
      }

      function create_decks(decks, message) {
        clear_decks(deck_wrapper);

        for (let i = 0; i < Object.keys(decks).length; i++) {
          let deck = document.createElement("a");
          deck.className = "deck";
          deck.id = i;
          deck.href = "../deck_detail/" + decks[i]["id"];
          deck.innerText = decks[i]["name"];
          deck_wrapper.appendChild(deck);
        }
        deck_wrapper.style.opacity = "1";
        message.innerText = "";
      }
    </script>
  </body>
</html>
